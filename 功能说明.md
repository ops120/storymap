# 众生谱功能说明 v1.0

**作者：你们喜爱的老王**

---

## 🎯 核心功能概览

### 1. 多模型管理系统

#### 特性
- ✅ 支持添加无限个 LLM 模型配置
- ✅ 支持三种主流协议：OpenAI、火山方舟、阿里百炼
- ✅ 自定义 Base URL，适配各种代理和私有部署
- ✅ 内置连接测试，确保配置正确
- ✅ 设置默认模型，简化使用流程
- ✅ 数据持久化，配置永久保存

#### 使用场景
1. **多账号管理**：配置多个 API Key，避免单账号限流
2. **成本优化**：根据任务复杂度选择不同价格的模型
3. **容灾备份**：主模型故障时快速切换备用模型
4. **性能对比**：同一文本用不同模型分析，对比效果

---

### 2. 智能文本分析

#### 工作流程
```
输入文本 → 自动分块 → LLM 推演 → 提取结构 → 入库存储 → 图谱渲染
```

#### 分析能力
- **人物识别**：自动提取人物姓名和唯一 ID
- **势力归属**：识别人物所属门派、组织、阵营
- **关系提取**：分析人物间的关系类型（师徒、道侣、敌对等）
- **增量更新**：多次分析自动合并，不会重复

#### 系统提示词
默认提示词已优化，确保返回标准 JSON 格式：
```
你是一个专业的小说关系分析提取器。请提取 nodes 和 edges。
必须严格返回合法的 JSON 格式，不要包含任何 markdown 代码块标记。
```

---

### 3. 关系图谱可视化

#### 图形特性
- **力导向布局**：节点自动排列，关系清晰
- **交互操作**：
  - 拖拽画布：移动视图
  - 滚轮缩放：调整大小
  - 拖拽节点：调整位置
- **动态渲染**：数据更新后自动刷新，无需手动操作

#### 视觉设计
- 节点：圆形，显示人物姓名
- 连线：箭头，显示关系类型
- 颜色：根据势力自动分配（未来版本）

---

### 4. 项目（卷宗）管理

#### 功能
- **多项目隔离**：每个小说独立存储，互不干扰
- **快速切换**：点击项目名即可切换
- **重命名卷宗**：点击 ✏️ 按钮修改卷宗名称
- **删除卷宗**：点击 🗑️ 按钮删除（需确认）
- **数据导出**：导出为 JSON 格式，便于备份和分享
- **数据导入**：导入他人分享的卷宗数据
- **智能去重**：点击"🧹 清理重复"自动合并重复节点

#### 使用建议
- 一部小说创建一个卷宗
- 定期导出备份，防止数据丢失
- 可以为同一小说创建多个版本（如"初稿"、"修订版"）
- 发现重复节点时及时清理

---

### 5. 文本输入与分析

#### 输入方式
- **手动粘贴**：直接粘贴文本到输入框
- **导入文件**：点击"导入文本"上传 .txt 文件
- **自动编码检测**：支持 UTF-8、UTF-16、GBK 等编码

#### 切片功能
- **默认大小**：500 字/块
- **可调范围**：100-5000 字
- **实时调整**：在输入框上方调整切片大小
- **自动保存**：切片设置自动持久化

#### 分析过程
- 实时显示进度百分比
- 自动去重节点（基于 label）
- 自动合并关系演变
- 分析完成后自动清空输入框

---

### 6. 关系演变追踪

#### 特性
- **自动合并**：同一对人物的关系会自动合并
- **演变链**：显示为"同学 → 恋人 → 夫妻 → 离婚"
- **视觉增强**：复合关系用红色粗线显示
- **时间戳**：记录每个关系阶段的创建时间

#### 工作原理
```
第一次分析：A 与 B 是同学
第二次分析：A 与 B 是恋人
结果：A → B: "同学 → 恋人"

第三次分析：A 与 B 是夫妻
结果：A → B: "同学 → 恋人 → 夫妻"
```

---

### 7. 配置管理系统

#### 配置项
- **系统提示词**：自定义 AI 分析的提示词
- **Debug 模式**：开启后显示详细日志
- **切片大小**：设置默认切片大小
- **UI 设置**：布局宽度等界面配置

#### 访问方式
- 点击顶部"⚙️ 配置"按钮
- 或在顶部直接勾选 Debug 复选框

#### 配置持久化
- 自动保存到 LocalStorage
- 刷新页面后保持设置
- 支持一键重置默认值

---

### 8. Debug 模式

#### 功能
- **模型配置日志**：显示当前使用的模型信息
- **系统提示词日志**：显示发送给 AI 的完整提示词
- **文本切片日志**：显示每个切片的内容和大小
- **API 请求日志**：显示请求参数和响应数据
- **错误日志**：详细的错误信息和堆栈

#### 使用场景
- 优化系统提示词
- 调试 AI 响应问题
- 排查分析失败原因
- 验证切片是否合理

---

## 🔮 LLM 模型管理详解

### 界面布局

```
┌─────────────────────────────────────────┐
│  🔮 演化法阵管理 (LLM Models)      [×]  │
├─────────────────────────────────────────┤
│  ┌─ 添加新模型 ─────────────────────┐  │
│  │ 模型名称: [通义千问-Plus        ]  │  │
│  │ 协议类型: [bailian ▼]            │  │
│  │ Model ID: [qwen-plus            ]  │  │
│  │ Base URL: [https://dashscope...  ]  │  │
│  │ API Key:  [••••••••••••••••••••]  │  │
│  │ □ 设为默认模型                    │  │
│  │ [🧪 测试连接] [➕ 添加]           │  │
│  └───────────────────────────────────┘  │
│                                          │
│  ┌─ 已配置的模型 ───────────────────┐  │
│  │ 通义千问-Plus          [默认]     │  │
│  │ 阿里百炼 | qwen-plus              │  │
│  │ [✓ 已选择] [编辑] [删除]          │  │
│  ├───────────────────────────────────┤  │
│  │ GPT-4                             │  │
│  │ OpenAI | gpt-4                    │  │
│  │ [选择] [编辑] [删除]              │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 操作流程

#### 添加模型
1. 点击"🔮 法阵管理"
2. 填写模型信息
3. 点击"🧪 测试连接"
4. 测试成功后点击"➕ 添加"

#### 编辑模型
1. 在模型列表中点击"编辑"
2. 修改配置信息
3. 重新测试连接
4. 点击"💾 更新"

#### 删除模型
1. 点击"删除"按钮
2. 确认删除操作
3. 如果是当前选中的模型，需重新选择

#### 切换模型
1. 在模型列表中点击"选择"
2. 当前选中的模型显示"✓ 已选择"
3. 推演时自动使用选中的模型

---

## 📊 数据流转

### 完整流程

```
用户输入
   ↓
[文本分块] (每块 800 字)
   ↓
[选择 LLM] (从配置列表选择)
   ↓
[API 调用] (发送到 LLM 服务)
   ↓
[解析响应] (提取 JSON 数据)
   ↓
[数据入库] (存入 SQLite)
   ↓
[图谱渲染] (G6 可视化)
```

### 数据格式

#### LLM 返回格式
```json
{
  "nodes": [
    {"id": "char_001", "label": "韩立", "sect": "黄枫谷"},
    {"id": "char_002", "label": "李化元", "sect": "黄枫谷"}
  ],
  "edges": [
    {"source": "char_001", "target": "char_002", "label": "师徒"}
  ]
}
```

#### 数据库存储
```sql
-- 节点表
INSERT INTO nodes VALUES ('char_001', '韩立', '黄枫谷', 'proj_abc123');

-- 关系表
INSERT INTO edges VALUES ('edge_xyz789', 'char_001', 'char_002', '师徒', 'proj_abc123');
```

---

## 🎨 界面布局

```
┌──────────┬──────────────┬─────────────────────┐
│          │              │                     │
│  卷宗    │  演化控制台  │    关系图谱投影     │
│  管理    │              │                     │
│          │  ┌────────┐  │   ○────○           │
│ ○ 凡人   │  │        │  │   │    │           │
│ ○ 斗破   │  │ 文本框 │  │   ○    ○           │
│          │  │        │  │    \  /            │
│ [新建]   │  └────────┘  │     ○              │
│ [✏️][🗑️] │              │                     │
│          │  切片: 500   │   [拖拽] [缩放]    │
│ 🔮 法阵  │  当前法阵:   │                     │
│ ⚙️ 配置  │  通义千问 ▼  │   复合关系: 红线   │
│ 📥 导入  │              │                     │
│ 📤 导出  │  [导入文本]  │   节点: 12         │
│ 🧹 清理  │  [🔥 炼化]   │   关系: 8          │
│          │              │                     │
└──────────┴──────────────┴─────────────────────┘
    ↕️           ↕️              (可拖拽调整)
```

### 布局特性
- **三栏可调**：拖拽分隔条调整宽度
- **最小宽度**：左侧 200px，中间 300px
- **响应式**：自动适应屏幕大小
- **持久化**：布局设置自动保存

---

## 🚀 性能优化

### 文本分块
- 默认每块 500 字（可调整 100-5000）
- 避免单次请求过长导致超时
- 支持自定义分块大小
- 配置自动持久化

### 智能去重
- 实时去重：分析时自动检测重复节点
- 手动清理：点击"🧹 清理重复"按钮
- 基于 label 匹配（忽略大小写）
- 自动更新边的引用
- 删除孤立边

### 关系合并
- 自动检测同一对人物的多个关系
- 按时间顺序合并为演变链
- 使用 → 符号连接各阶段
- 复合关系视觉增强（红色粗线）

### 进度显示
- 实时显示推演进度百分比
- 分块处理，逐步更新
- 避免界面卡顿

### 数据缓存
- 项目数据缓存在前端状态
- 切换项目时重新加载
- 减少不必要的 API 调用

---

## 🔒 安全性

### API Key 保护
- 存储在 SQLite 数据库
- 界面显示为密码格式
- 不会在日志中打印

### 数据隔离
- 每个项目独立存储
- 不同用户数据物理隔离
- 支持数据导出备份

---

## 💡 使用技巧

### 1. 提高准确率
- 输入完整的章节内容，避免片段
- 使用高质量模型（如 qwen-max, gpt-4）
- 优化系统提示词，增加示例
- 开启 Debug 模式查看 AI 响应
- 明确 ID 命名规则（小写拼音，无下划线）

### 2. 降低成本
- 使用经济型模型（如 qwen-turbo）
- 调整切片大小，避免重复内容
- 批量处理，减少 API 调用次数
- 定期清理重复节点

### 3. 提升速度
- 使用快速模型（如 qwen-turbo）
- 适当增大分块大小，减少请求次数
- 配置多个模型，快速切换
- 使用"清理重复"而非重新分析

### 4. 数据管理
- 定期导出备份
- 使用有意义的卷宗名称
- 及时清理不需要的卷宗
- 利用重命名功能组织项目

---

## 🔧 故障排查

### 问题：测试连接失败
- 检查 API Key 是否正确
- 检查 Base URL 是否可访问
- 检查网络连接是否正常
- 查看后端日志获取详细错误
- 尝试使用其他模型

### 问题：推演无结果
- 检查是否选择了 LLM 模型
- 检查文本是否包含人物信息
- 查看后端日志确认 API 调用状态
- 开启 Debug 模式查看详细日志
- 尝试使用不同的模型

### 问题：图谱不显示
- 检查是否有节点和关系数据
- 刷新页面重新加载
- 查看浏览器控制台错误信息
- 确认 G6 库是否正确加载
- 尝试重新分析文本

### 问题：出现重复节点
- 点击"🧹 清理重复"按钮
- 系统会自动合并同名节点
- 优化系统提示词，强调 ID 一致性
- 使用 Debug 模式检查 AI 输出

### 问题：文本导入乱码
- 系统会自动尝试多种编码
- 支持 UTF-8、UTF-16、GBK
- 如仍有问题，尝试转换文件编码
- 或直接粘贴文本内容

### 问题：关系未合并
- 确认是同一对人物（source 和 target 相同）
- 检查节点 ID 是否一致
- 使用"清理重复"功能
- 查看 Debug 日志确认关系数据

---

## 📈 未来规划

- [ ] 支持流式响应，实时显示推演结果
- [ ] 支持自定义节点颜色和样式
- [ ] 支持关系强度计算和可视化
- [ ] 支持人物出场频率统计
- [ ] 支持多模型并行推演
- [ ] 支持导出为图片和 PDF
- [ ] 支持 Docker 一键部署
- [ ] 支持 Tauri 桌面应用打包
- [ ] 支持更多 LLM 协议（Claude、Gemini 等）
- [ ] 支持自定义关系类型和颜色
- [ ] 支持时间线视图
- [ ] 支持人物属性编辑

---

## 📚 相关文档

- [README.md](README.md) - 项目说明和快速开始
- [安装指南.md](安装指南.md) - 详细安装步骤
- [使用技巧.md](使用技巧.md) - 高效使用技巧
- [快速参考.md](快速参考.md) - 常用命令速查
- [项目结构.md](项目结构.md) - 代码结构说明
- [CHANGELOG-v1.0.md](CHANGELOG-v1.0.md) - v1.0 版本详情

---

**众生谱 v1.0 - 让人物关系一目了然** 🎉  
**作者：你们喜爱的老王**
