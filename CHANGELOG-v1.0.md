# 众生谱 StoryMap v1.0 正式版

**发布日期：** 2024-02-19  
**作者：你们喜爱的老王**

---

## 🎉 版本亮点

众生谱 v1.0 是一个基于大语言模型的叙事关系分析工具，能够自动从小说文本中提取人物关系网络，并以可视化图谱的形式展示。

### 核心特性

1. **智能关系提取** - 使用 LLM 自动分析文本，提取人物和关系
2. **多模型支持** - 支持 OpenAI、火山方舟、阿里百炼三种协议
3. **关系演变追踪** - 自动合并关系演变（同学 → 恋人 → 夫妻）
4. **可视化图谱** - 基于 G6 的交互式关系图谱
5. **数据持久化** - SQLite 本地存储，支持导入导出
6. **可调整布局** - 三栏布局可自由拖拽调整
7. **Debug 模式** - 完整的调试信息，方便优化提示词

---

## ✨ 主要功能

### 1. 卷宗管理
- ✅ 创建多个独立的卷宗（项目）
- ✅ 重命名卷宗
- ✅ 删除卷宗
- ✅ 导入/导出卷宗数据（JSON 格式）
- ✅ 自动去重和数据清理

### 2. LLM 模型管理
- ✅ 支持多个 LLM 模型配置
- ✅ 三种协议：OpenAI、火山方舟（Volcano）、阿里百炼（Bailian）
- ✅ 自定义 API 地址和模型 ID
- ✅ 模型连接测试
- ✅ 快速切换模型

### 3. 文本分析
- ✅ 手动粘贴文本
- ✅ 导入 .txt 文件（自动检测编码）
- ✅ 可调整切片大小（默认 500 字）
- ✅ 实时进度显示
- ✅ 自动去重节点
- ✅ 关系演变自动合并

### 4. 关系图谱
- ✅ 力导向布局
- ✅ 拖拽移动节点
- ✅ 滚轮缩放
- ✅ 拖拽画布
- ✅ 复合关系高亮显示（红色粗线）
- ✅ 节点和关系统计

### 5. 配置管理
- ✅ 自定义系统提示词
- ✅ Debug 模式开关
- ✅ 切片大小设置
- ✅ 配置持久化（LocalStorage）
- ✅ 一键重置默认配置

### 6. 用户界面
- ✅ 现代化渐变主题
- ✅ 三栏可调整布局
- ✅ 响应式设计
- ✅ 全屏适配
- ✅ 流畅的交互动画

---

## 🏗️ 技术架构

### 前端技术栈
- **框架**: React 18
- **状态管理**: Zustand
- **图形引擎**: AntV G6 4.x
- **构建工具**: Vite 7
- **样式**: 内联样式 + 渐变主题

### 后端技术栈
- **框架**: FastAPI
- **数据库**: SQLite
- **AI 接口**: OpenAI SDK（兼容多种协议）
- **语言**: Python 3.8+

### 数据库设计
```sql
-- 项目表
projects (id, name)

-- 节点表（人物）
nodes (id, label, sect, project_id)

-- 边表（关系）
edges (id, source, target, label, project_id, stage, created_at)

-- LLM 模型表
llm_models (id, name, protocol, api_key, base_url, model_id, is_default, created_at)
```

---

## 📦 安装部署

### 环境要求
- Python 3.8+
- Node.js 16+
- Conda（推荐使用 vevo 环境）

### 快速开始

1. **克隆项目**
```bash
git clone <repository-url>
cd story-map
```

2. **安装依赖**
```bash
# 后端
conda activate vevo
pip install -r requirements.txt

# 前端
cd frontend
npm install
```

3. **启动服务**
```bash
# 方式1：一键启动（推荐）
start.cmd

# 方式2：分别启动
start_backend.cmd  # 后端
start_frontend.cmd # 前端
```

4. **访问应用**
- 前端：http://localhost:5173
- 后端：http://127.0.0.1:8000

---

## 📖 使用指南

### 基本工作流程

1. **配置 LLM 模型**
   - 点击顶部"🔮 法阵管理"
   - 添加 LLM 模型配置
   - 测试连接
   - 设置为默认模型

2. **创建卷宗**
   - 在左侧输入卷宗名称
   - 点击"+"创建

3. **分析文本**
   - 粘贴文本或导入 .txt 文件
   - 调整切片大小（可选）
   - 选择 LLM 模型
   - 点击"🔥 开始炼化"

4. **查看图谱**
   - 右侧自动显示关系图谱
   - 拖拽节点调整位置
   - 滚轮缩放查看细节

5. **清理数据**
   - 点击"🧹 清理重复"
   - 自动合并重复节点
   - 删除孤立边

6. **导出数据**
   - 点击"📤 导出卷宗"
   - 保存为 JSON 文件

### 高级功能

#### Debug 模式
- 点击顶部 Debug 复选框
- 或在"⚙️ 配置"中开启
- 查看控制台的详细日志

#### 自定义提示词
- 点击"⚙️ 配置"
- 编辑系统提示词
- 自动保存

#### 布局调整
- 拖拽左右两个分隔条
- 调整三栏宽度
- 适应不同屏幕尺寸

---

## 🎯 最佳实践

### 提示词优化建议
1. 明确 ID 命名规则（小写拼音，无下划线）
2. 提供关系类型示例
3. 强调一致性要求
4. 使用 Debug 模式查看 AI 响应

### 切片大小建议
- **短篇小说**: 500-800 字
- **长篇小说**: 800-1500 字
- **对话密集**: 300-500 字
- **描述性文本**: 1000-2000 字

### 性能优化
- 定期清理重复节点
- 避免单次分析过长文本
- 使用合适的切片大小
- 选择响应速度快的模型

---

## 🐛 已知问题

1. **节点重复**
   - 原因：AI 可能使用不同的 ID 命名
   - 解决：点击"🧹 清理重复"按钮

2. **编码问题**
   - 原因：文件编码不是 UTF-8
   - 解决：系统会自动尝试 GBK 编码

3. **图谱不显示**
   - 原因：数据格式错误或 G6 初始化失败
   - 解决：查看控制台错误信息，重新分析

---

## 🔄 升级说明

### 从 v2.3 升级到 v1.0

v1.0 是正式版本，包含了所有 v2.x 的功能改进：

1. **数据库变更**
   - edges 表新增 stage 和 created_at 字段
   - 自动迁移，无需手动操作

2. **配置文件**
   - 新增 config.js 配置文件
   - 旧配置会自动迁移到新格式

3. **功能增强**
   - 新增清理重复功能
   - 新增 Debug 模式
   - 新增配置管理界面

---

## 📝 配置文件说明

### frontend/src/config.js
```javascript
{
  debug: false,              // Debug 模式
  defaultChunkSize: 500,     // 默认切片大小
  systemPrompt: "...",       // 系统提示词
  apiConfig: {
    timeout: 60000,          // 请求超时
    retryCount: 2            // 重试次数
  },
  ui: {
    defaultLeftWidth: 240,   // 左侧默认宽度
    defaultMiddleWidth: 360  // 中间默认宽度
  }
}
```

---

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

### 开发环境设置
```bash
# 安装开发依赖
pip install -r requirements.txt
cd frontend && npm install

# 启动开发服务器
python backend/main.py
cd frontend && npm run dev
```

### 代码规范
- Python: PEP 8
- JavaScript: ESLint
- 提交信息: Conventional Commits

---

## 📄 许可证

MIT License

---

## 🙏 致谢

- AntV G6 - 图形可视化引擎
- FastAPI - 现代化 Python Web 框架
- React - 用户界面库
- Zustand - 轻量级状态管理

---

## 👨‍💻 作者

**你们喜爱的老王**

感谢所有使用和支持众生谱的朋友们！

---

## 📞 联系方式

- 项目地址: [GitHub Repository]
- 问题反馈: [Issues]
- 文档: 查看项目根目录的 .md 文件

---

**众生谱 v1.0 - 让人物关系一目了然** 🎉  
**作者：你们喜爱的老王**
