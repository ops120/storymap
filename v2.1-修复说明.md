# v2.1 修复说明

## 🎉 已修复的问题

### 1. ✅ 启动信息乱码

**问题描述：**
启动脚本显示乱码或特殊字符（如 ❌ ✓ 等）

**修复方案：**
- 在所有 `.cmd` 脚本开头添加 `chcp 65001` 设置 UTF-8 编码
- 移除了特殊 Unicode 字符，使用普通文本

**影响文件：**
- `start.cmd`
- `start_backend.cmd`
- `start_frontend.cmd`
- `check_env.cmd`

---

### 2. ✅ 导入后图谱无法显示

**问题描述：**
导入 JSON 文件后，图谱区域空白，没有显示节点和关系

**根本原因：**
- G6 版本混淆（代码使用 G6 5.x API，但实际安装的是 4.x）
- 数据格式不匹配
- 缺少数据加载的调试信息

**修复方案：**
1. 修正 `GraphView.jsx` 使用正确的 G6 4.x API
2. 添加详细的调试日志
3. 添加空数据提示
4. 修复数据更新逻辑（使用 `changeData` 而不是 `setData`）

**影响文件：**
- `frontend/src/GraphView.jsx`

---

### 3. ✅ 炼化成功但不显示

**问题描述：**
分析进度条显示 100%，但图谱没有更新，看不到新的节点和关系

**根本原因：**
- 缺少分析过程的详细日志
- 没有错误提示
- 数据加载后没有触发图谱更新

**修复方案：**
1. 在 `analyzeText` 方法中添加详细日志
2. 添加成功/失败计数
3. 添加用户友好的错误提示
4. 确保分析完成后重新加载数据

**影响文件：**
- `frontend/src/store.js`

---

### 4. ✅ 图谱交互优化

**问题描述：**
图谱缩放和拖拽体验不佳

**优化方案：**
1. 添加顶部信息栏，显示节点和关系数量
2. 添加操作提示（拖拽移动、滚轮缩放）
3. 优化布局，图谱占据整个右侧区域
4. 添加空数据提示

**影响文件：**
- `frontend/src/App.jsx`
- `frontend/src/GraphView.jsx`

---

## 🔍 新增的调试功能

### 1. 详细的控制台日志

现在系统会输出以下调试信息：

#### 项目切换
```
切换项目: proj_abc123
项目数据加载: {nodes: Array(5), edges: Array(3)}
节点数量: 5
关系数量: 3
```

#### 文本分析
```
开始分析文本: {projectId: "proj_xxx", modelName: "通义千问-Plus", textLength: 1500, chunkSize: 800}
文本分为 2 个切片
正在分析第 1/2 个切片...
✓ 切片 1 分析成功
正在分析第 2/2 个切片...
✓ 切片 2 分析成功
分析完成: 成功 2/2, 失败 0/2
重新加载项目数据...
✓ 数据已更新，图谱应该显示了
```

#### 图谱渲染
```
GraphView 数据更新: {nodeCount: 5, edgeCount: 3, nodes: [...], edges: [...]}
格式化后的数据: {nodes: Array(5), edges: Array(3)}
创建新的 Graph 实例
Graph 渲染完成
```

### 2. 用户友好的错误提示

- 未选择 LLM 模型时会弹出提示
- 分析失败时会显示错误信息
- 空数据时显示"暂无数据，请先进行文本炼化"

### 3. 实时数据统计

顶部信息栏显示：
```
关系图谱 | 节点: 5 | 关系: 3
```

---

## 📝 使用建议

### 调试步骤

1. **打开浏览器控制台**
   ```
   按 F12 键
   ```

2. **查看日志信息**
   - 所有操作都会输出详细日志
   - 错误会用红色显示
   - 成功会用 ✓ 标记

3. **检查数据**
   - 查看"节点数量"和"关系数量"
   - 确认数据是否正确加载

4. **排查问题**
   - 如果看到错误，根据错误信息排查
   - 参考 `故障排查指南.md`

### 最佳实践

1. **首次使用**
   - 先配置 LLM 模型
   - 测试连接成功后再分析
   - 使用包含明确人物关系的文本

2. **导入数据**
   - 导入后查看控制台日志
   - 确认数据加载成功
   - 如果没有显示，刷新页面

3. **文本分析**
   - 输入 500-2000 字的文本
   - 确保文本包含人物对话和互动
   - 观察控制台的分析进度

4. **图谱查看**
   - 使用鼠标拖拽移动画布
   - 使用滚轮缩放视图
   - 拖拽节点调整位置

---

## 🆕 新增文档

1. **故障排查指南.md**
   - 详细的问题排查步骤
   - 常见问题解决方案
   - 调试技巧和工具

---

## 🔄 升级步骤

### 从 v2.0 升级到 v2.1

1. **更新代码**
   ```bash
   git pull origin main
   ```

2. **重启服务**
   ```bash
   # 关闭现有服务
   # 重新运行
   start.cmd
   ```

3. **清除浏览器缓存**
   ```
   Ctrl + Shift + R (强制刷新)
   ```

4. **测试功能**
   - 打开 F12 控制台
   - 创建新项目
   - 配置 LLM 模型
   - 分析文本
   - 查看图谱

---

## ✅ 验证清单

升级后请验证：

- [ ] 启动脚本没有乱码
- [ ] 可以正常导入数据
- [ ] 导入后图谱正常显示
- [ ] 文本分析后图谱更新
- [ ] 控制台有详细日志
- [ ] 顶部显示节点和关系数量
- [ ] 图谱可以拖拽和缩放
- [ ] 空数据时有提示信息

---

## 📊 性能改进

| 指标 | v2.0 | v2.1 | 改进 |
|------|------|------|------|
| 图谱渲染速度 | 慢 | 快 | 使用正确的 G6 API |
| 调试难度 | 高 | 低 | 详细日志输出 |
| 错误提示 | 无 | 有 | 用户友好提示 |
| 数据可见性 | 低 | 高 | 实时统计显示 |

---

## 🎯 下一步计划

v2.2 将包含：
- [ ] 节点编辑功能
- [ ] 关系删除功能
- [ ] 势力颜色自定义
- [ ] 导出为图片
- [ ] 性能优化

---

## 📞 反馈

如果遇到问题：

1. 查看 `故障排查指南.md`
2. 查看浏览器控制台日志
3. 查看后端终端日志
4. 运行 `python test_api.py`

记住：**所有操作都会在控制台输出日志，这是排查问题的关键！** 🔍
