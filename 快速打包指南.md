# 众生谱快速打包指南

**作者：你们喜爱的老王**

---

## 🚀 一键打包（推荐）

### 前提条件
- ✅ 已安装 Conda 并创建 vevo 环境
- ✅ 已安装 Node.js
- ✅ 项目代码完整

### 执行打包

```bash
# 运行自动打包脚本
build-exe.cmd
```

脚本会自动完成：
1. 激活 Conda 环境
2. 安装打包工具（PyInstaller、electron-builder）
3. 打包后端为 exe
4. 构建前端静态文件
5. 组织文件结构
6. 打包 Electron 应用

### 输出文件

打包完成后，在 `electron-build/dist/` 目录下会生成：

- **众生谱 Setup 1.0.0.exe** - 安装程序（推荐分发）
- **众生谱-1.0.0-portable.exe** - 便携版（可选）

---

## 📦 手动打包步骤

如果自动脚本失败，可以手动执行以下步骤：

### 1. 准备环境

```bash
# 激活 Conda 环境
conda activate vevo

# 安装 PyInstaller
pip install pyinstaller

# 安装 Electron Builder（全局）
npm install -g electron-builder
```

### 2. 打包后端

```bash
cd backend

# 首次打包（生成 spec 文件）
pyinstaller --name=storymap-backend --onefile --noconsole main.py

# 后续打包（使用 spec 文件）
pyinstaller main.spec --clean

cd ..
```

生成文件：`backend/dist/storymap-backend.exe`

### 3. 构建前端

```bash
cd frontend
npm run build
cd ..
```

生成目录：`frontend/dist/`

### 4. 准备 Electron 项目

```bash
# 如果 electron 目录不存在，需要先创建
# 参考：打包为EXE指南.md

cd electron
npm install
cd ..
```

### 5. 组织文件

```bash
# 创建打包目录
mkdir electron-build

# 复制 Electron 文件
xcopy /E /I /Y electron electron-build

# 复制前端
xcopy /E /I /Y frontend\dist electron-build\frontend

# 复制后端
mkdir electron-build\backend
copy backend\dist\storymap-backend.exe electron-build\backend\
```

### 6. 打包 Electron

```bash
cd electron-build
npm install
npm run build
cd ..
```

---

## 🎯 打包选项

### 安装程序（NSIS）

```bash
cd electron-build
npm run build:win
```

特点：
- 标准 Windows 安装程序
- 可选择安装目录
- 创建桌面快捷方式
- 添加到开始菜单
- 支持卸载

### 便携版（Portable）

```bash
cd electron-build
npm run build:portable
```

特点：
- 单个 exe 文件
- 无需安装
- 解压即用
- 适合 U 盘携带

---

## 📊 打包后文件大小

| 文件 | 大小 | 说明 |
|------|------|------|
| 后端 exe | ~30MB | Python 运行时 + 依赖 |
| 前端资源 | ~5MB | HTML/CSS/JS + G6 |
| Electron | ~100MB | Chromium + Node.js |
| **总计** | **~135MB** | 完整安装包 |
| 压缩后 | ~50MB | 使用 7z 压缩 |

---

## ⚠️ 常见问题

### 问题1：PyInstaller 打包失败

**错误信息：** `ModuleNotFoundError: No module named 'xxx'`

**解决方案：**
1. 在 `main.spec` 的 `hiddenimports` 中添加缺失的模块
2. 重新打包：`pyinstaller main.spec --clean`

### 问题2：后端 exe 无法启动

**解决方案：**
1. 检查是否有杀毒软件拦截
2. 尝试以管理员身份运行
3. 查看 Windows 事件查看器中的错误日志
4. 使用 `--console` 选项重新打包查看错误信息

### 问题3：Electron 打包失败

**错误信息：** `Cannot find module 'electron'`

**解决方案：**
```bash
cd electron-build
rm -rf node_modules
npm install
npm run build
```

### 问题4：打包后体积过大

**解决方案：**
1. 使用 UPX 压缩（已在 spec 中启用）
2. 排除不需要的模块（在 spec 的 `excludes` 中添加）
3. 使用 7z 压缩最终的 exe

### 问题5：打包后无法连接后端

**解决方案：**
1. 检查防火墙设置
2. 确认端口 8000 未被占用
3. 查看 Electron 控制台的错误信息
4. 增加后端启动等待时间（在 main.js 中）

---

## 🔧 优化建议

### 减小体积

1. **后端优化**
   - 排除不需要的 Python 模块
   - 使用 UPX 压缩
   - 移除调试信息

2. **前端优化**
   - 启用代码压缩
   - 移除 source maps
   - 优化图片资源

3. **Electron 优化**
   - 使用 asar 打包
   - 启用压缩选项

### 提升性能

1. **后端启动优化**
   - 使用更快的 ASGI 服务器
   - 延迟加载大型模块
   - 优化数据库连接

2. **前端加载优化**
   - 代码分割
   - 懒加载组件
   - 缓存静态资源

---

## 📝 打包检查清单

打包前确认：
- [ ] 所有功能测试通过
- [ ] 版本号已更新（package.json）
- [ ] 图标文件已准备（icon.ico）
- [ ] 数据库路径已修改为用户目录
- [ ] 移除了调试代码和日志
- [ ] 更新了 README 和文档

打包后测试：
- [ ] 安装程序可以正常安装
- [ ] 应用可以正常启动
- [ ] 后端服务正常运行
- [ ] 前端界面正常显示
- [ ] 所有功能正常工作
- [ ] 卸载程序正常工作
- [ ] 在干净的系统上测试

---

## 🚀 发布流程

### 1. 准备发布

```bash
# 打包
build-exe.cmd

# 测试
# 在干净的 Windows 系统上测试安装和运行

# 创建压缩包
cd electron-build\dist
7z a 众生谱-v1.0.0-win64.7z "众生谱 Setup 1.0.0.exe"
```

### 2. 发布到 GitHub

```bash
# 创建 Git 标签
git tag -a v1.0.0 -m "众生谱 v1.0.0 正式版"
git push origin v1.0.0

# 在 GitHub 上创建 Release
# 上传打包好的 exe 文件
```

### 3. 编写发布说明

在 GitHub Release 中添加：
- 版本亮点
- 新增功能
- 修复的问题
- 下载链接
- 安装说明

---

## 📚 相关文档

- [打包为EXE指南.md](打包为EXE指南.md) - 详细的打包方案
- [CHANGELOG-v1.0.md](CHANGELOG-v1.0.md) - 版本更新日志
- [README.md](README.md) - 项目说明

---

**众生谱 v1.0 - 一键打包，开箱即用** 🎉  
**作者：你们喜爱的老王**
