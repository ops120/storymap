# 故障排查指南

## 🔍 如何查看调试信息

### 打开浏览器控制台

1. 在浏览器中按 `F12` 键
2. 或右键点击页面 → 选择"检查"
3. 切换到"Console"（控制台）标签页

### 查看日志信息

系统会输出详细的调试信息：

```
切换项目: proj_abc123
项目数据加载: {nodes: Array(5), edges: Array(3)}
节点数量: 5
关系数量: 3
GraphView 数据更新: {nodeCount: 5, edgeCount: 3, ...}
创建新的 Graph 实例
Graph 渲染完成
```

---

## 🐛 问题1：启动信息乱码

### 症状
启动脚本显示乱码或特殊字符

### 解决方案
已修复！新版 `start.cmd` 已添加 `chcp 65001` 设置 UTF-8 编码。

如果仍有问题：
1. 右键点击命令行窗口标题栏
2. 选择"属性"
3. 在"选项"标签页中，将"旧版控制台"取消勾选
4. 重启命令行

---

## 🐛 问题2：导入后图谱无法显示

### 症状
导入 JSON 文件后，图谱区域空白

### 排查步骤

#### 1. 检查数据是否导入成功

打开浏览器控制台（F12），查看是否有错误信息。

#### 2. 检查项目是否自动切换

导入后应该自动切换到新项目，查看左侧卷宗列表是否有新项目。

#### 3. 手动刷新数据

```javascript
// 在控制台执行
location.reload()
```

#### 4. 检查数据库

使用 SQLite 工具打开 `storymap.db`：

```sql
-- 查看所有项目
SELECT * FROM projects;

-- 查看节点数据
SELECT * FROM nodes WHERE project_id = 'proj_xxx';

-- 查看关系数据
SELECT * FROM edges WHERE project_id = 'proj_xxx';
```

### 解决方案

**方案1：重新导入**
1. 删除导入失败的项目
2. 重新导入 JSON 文件
3. 查看控制台日志

**方案2：手动切换项目**
1. 点击其他项目
2. 再点击回导入的项目
3. 数据应该会重新加载

**方案3：检查 JSON 格式**

确保导出的 JSON 格式正确：

```json
{
  "project": {
    "id": "proj_xxx",
    "name": "项目名称"
  },
  "nodes": [
    {"id": "char_001", "label": "人物名", "sect": "门派", "project_id": "proj_xxx"}
  ],
  "edges": [
    {"id": "edge_001", "source": "char_001", "target": "char_002", "label": "关系", "project_id": "proj_xxx"}
  ]
}
```

---

## 🐛 问题3：炼化成功但不显示

### 症状
进度条显示 100%，但图谱没有更新

### 排查步骤

#### 1. 查看控制台日志

打开 F12 控制台，查找以下信息：

```
开始分析文本: {projectId: "proj_xxx", modelName: "通义千问-Plus", ...}
文本分为 2 个切片
正在分析第 1/2 个切片...
✓ 切片 1 分析成功
正在分析第 2/2 个切片...
✓ 切片 2 分析成功
分析完成: 成功 2/2, 失败 0/2
重新加载项目数据...
切换项目: proj_xxx
项目数据加载: {nodes: Array(5), edges: Array(3)}
✓ 数据已更新，图谱应该显示了
```

#### 2. 检查是否有错误

如果看到：
```
✗ 切片 1 分析失败: AI未返回标准JSON
```

说明 LLM 返回的数据格式不正确。

#### 3. 检查后端日志

查看后端终端输出，确认 API 调用状态。

### 常见原因

**原因1：LLM 返回格式错误**

LLM 可能返回了 Markdown 格式或其他非 JSON 格式。

**解决：**
- 使用更稳定的模型（如 qwen-plus, gpt-4）
- 检查系统提示词是否正确

**原因2：文本中没有人物信息**

输入的文本可能不包含明确的人物关系。

**解决：**
- 输入包含人物对话和互动的章节
- 确保文本长度足够（建议 500-2000 字）

**原因3：API 调用失败**

网络问题或 API Key 无效。

**解决：**
- 检查网络连接
- 在"法阵管理"中重新测试模型连接
- 查看后端日志的详细错误信息

### 解决方案

**方案1：重新分析**
1. 清空文本框
2. 重新粘贴文本
3. 点击"开始炼化"
4. 观察控制台日志

**方案2：使用不同的模型**
1. 打开"法阵管理"
2. 切换到其他模型
3. 重新分析

**方案3：手动刷新**
```javascript
// 在控制台执行
location.reload()
```

---

## 🐛 问题4：图谱显示异常

### 症状
- 图谱显示空白
- 节点重叠
- 连线错乱

### 排查步骤

#### 1. 检查数据

打开控制台，查看：
```
GraphView 数据更新: {nodeCount: 5, edgeCount: 3, ...}
```

如果 nodeCount 为 0，说明没有数据。

#### 2. 检查 G6 初始化

查找以下日志：
```
创建新的 Graph 实例
Graph 渲染完成
```

如果看到错误，说明 G6 初始化失败。

### 解决方案

**方案1：刷新页面**
```
Ctrl + Shift + R (强制刷新)
```

**方案2：清除缓存**
1. 按 F12 打开控制台
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

**方案3：检查浏览器兼容性**

推荐使用：
- Chrome 90+
- Edge 90+
- Firefox 88+

---

## 🔧 通用调试技巧

### 1. 查看网络请求

1. 按 F12 打开控制台
2. 切换到"Network"（网络）标签页
3. 刷新页面
4. 查看所有 API 请求的状态

正常情况下应该看到：
- `GET /api/projects` - 200 OK
- `GET /api/llm-models` - 200 OK
- `GET /api/projects/{id}/data` - 200 OK
- `POST /api/projects/{id}/analyze` - 200 OK

### 2. 查看 API 响应

点击网络请求，查看"Response"（响应）标签页：

```json
{
  "nodes": [...],
  "edges": [...]
}
```

### 3. 手动测试 API

在控制台执行：

```javascript
// 测试获取项目列表
fetch('http://127.0.0.1:8000/api/projects')
  .then(r => r.json())
  .then(d => console.log('项目列表:', d));

// 测试获取项目数据
fetch('http://127.0.0.1:8000/api/projects/proj_xxx/data')
  .then(r => r.json())
  .then(d => console.log('项目数据:', d));
```

### 4. 检查状态

在控制台执行：

```javascript
// 查看当前状态
console.log('当前项目ID:', window.useStore.getState().currentProjectId);
console.log('节点数量:', window.useStore.getState().nodes.length);
console.log('关系数量:', window.useStore.getState().edges.length);
console.log('当前模型ID:', window.useStore.getState().currentLlmId);
```

---

## 📞 获取更多帮助

### 1. 导出日志

在控制台右键 → 选择"Save as..." → 保存日志文件

### 2. 导出数据库

```bash
copy storymap.db storymap_debug.db
```

### 3. 运行测试脚本

```bash
conda activate vevo
python test_api.py
```

### 4. 查看后端日志

后端终端会显示所有 API 请求和错误信息。

---

## ✅ 检查清单

在报告问题前，请确认：

- [ ] 已打开浏览器控制台（F12）
- [ ] 已查看控制台的错误信息
- [ ] 已查看网络请求状态
- [ ] 已检查后端日志
- [ ] 已尝试刷新页面
- [ ] 已尝试重新导入/分析
- [ ] 已检查 LLM 模型配置
- [ ] 已运行 `check_env.cmd`
- [ ] 已运行 `python test_api.py`

---

## 🎯 快速解决方案总结

| 问题 | 快速解决 |
|------|----------|
| 启动乱码 | 已修复，重新运行 start.cmd |
| 导入无显示 | 刷新页面，手动切换项目 |
| 炼化无显示 | 查看控制台日志，检查 LLM 配置 |
| 图谱异常 | Ctrl+Shift+R 强制刷新 |
| 网络错误 | 检查后端是否启动，端口是否正确 |
| 模型测试失败 | 检查 API Key 和网络连接 |

记住：**F12 控制台是你最好的朋友！** 🔍
