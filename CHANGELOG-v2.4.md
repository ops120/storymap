# 众生谱 v2.4 更新日志

**作者：你们喜爱的老王**

**发布日期：2026-02-19**

---

## 🎉 重大更新

### 1. 快速切换卷宗体验优化
- ✅ 立即响应切换操作（< 50ms）
- ✅ 两阶段加载提示：数据加载 + 图谱渲染
- ✅ 最小加载时间 300ms，确保用户能看到加载状态
- ✅ 当前卷宗显示加载状态（黄色背景 + 旋转图标）

### 2. 智能布局算法
- ✅ 节点数 ≤ 50：使用 force 布局（力导向，更美观）
- ✅ 节点数 > 50：使用 circular 布局（圆形，更快）
- ✅ 限制迭代次数，加快渲染速度

### 3. 数据完整性修复
- ✅ 前端自动过滤无效边（source/target 不存在的边）
- ✅ 后端 API 返回数据前自动验证和过滤
- ✅ 清理功能增强，显示被删除的孤立边详情
- ✅ 修复导入功能的数据库列数不匹配问题

### 4. 用户体验提升
- ✅ 文本输入区域显示总字数（实时更新，千分位格式）
- ✅ 作者信息显示在左下角（紫色渐变，更显眼）
- ✅ 加载状态提示更友好（旋转动画 + 进度文字）
- ✅ 图谱渲染采用销毁重建策略，更可靠

---

## 🐛 Bug 修复

### 前端修复
1. 修复 `store.js` 缺失 `exportProject` 和 `importProject` 方法
2. 修复 `App.jsx` 中 `s.currentProject` 引用错误（改为 `s.currentProjectId`）
3. 修复 `cleanupDuplicates` 调用缺少参数
4. 修复 GraphView 切换项目后图谱不显示的问题
5. 添加 spin 动画 CSS，确保加载图标正常显示

### 后端修复
1. 修复 `/api/projects/import` 接口的 SQL 列数不匹配错误
2. 修复 `analyze` 接口的 INSERT 语句列数问题
3. 增强 `/api/projects/{pid}/data` 接口，自动过滤无效边
4. 增强 `/api/projects/{pid}/cleanup` 接口，显示详细清理信息

---

## 📊 性能优化

1. **异步渲染**：使用 `requestAnimationFrame` 延迟渲染，不阻塞 UI
2. **数据验证**：前端和后端双重验证，避免无效数据导致渲染失败
3. **状态管理**：新增 `isLoadingProject` 状态，精确追踪加载过程
4. **图谱重建**：切换项目时销毁旧实例重建，避免状态残留

---

## 🎨 界面改进

1. 文本输入区域右上角显示总字数
2. 作者信息左下角显示（紫色渐变背景 + ✨ 图标）
3. 加载状态更直观（旋转动画 + 节点数量提示）
4. 当前卷宗加载时背景变黄色，更易识别

---

## 📝 技术细节

### 状态流转
```
用户点击 → 立即切换ID → 显示加载状态 → 异步加载数据 → 异步渲染图谱 → 完成
   ↓           ↓              ↓                ↓               ↓            ↓
  0ms        <50ms          50ms            200-1000ms      500-2000ms    完成
```

### 数据验证流程
```
后端 API → 过滤无效边 → 返回数据 → 前端验证 → 再次过滤 → 渲染图谱
```

---

## 🔧 开发者说明

### 新增状态
- `isLoadingProject`: boolean - 项目数据加载状态

### 新增方法
- `exportProject()`: 导出当前项目为 JSON
- `importProject(file)`: 从 JSON 文件导入项目

### 修改的文件
- `frontend/src/store.js` - 状态管理和数据加载
- `frontend/src/App.jsx` - UI 和交互逻辑
- `frontend/src/GraphView.jsx` - 图谱渲染和数据验证
- `backend/main.py` - API 接口和数据验证

---

## 📦 升级说明

从 v2.3 升级到 v2.4：

1. 拉取最新代码
2. 重启后端服务（修复了 SQL 错误）
3. 刷新前端页面
4. 建议运行"清理重复"功能清理数据库中的孤立边

---

## 🙏 致谢

感谢所有用户的反馈和建议！

---

**下一版本计划：**
- 数据预加载（鼠标悬停时预加载）
- 图谱缓存（切换回之前的卷宗时直接显示）
- 虚拟化渲染（超大数据量优化）
- 导出图谱为图片

---

**作者：你们喜爱的老王**  
**版本：v2.4**  
**日期：2026-02-19**
