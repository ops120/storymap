# 众生谱 v2.0 升级说明

## 🎉 欢迎升级到 v2.0

本次更新是一个重大版本升级，引入了全新的多 LLM 模型管理系统，大幅提升了灵活性和易用性。

---

## ✨ 核心变化

### 1. 从单模型到多模型

**v1.0（旧版）**
```javascript
// 只能配置一个模型
llmConfig: {
  api_key: 'sk-xxx',
  base_url: 'https://...',
  model: 'qwen-plus'
}
```

**v2.0（新版）**
```javascript
// 可以配置多个模型
llmModels: [
  { id: 'llm_001', name: '通义千问-Plus', protocol: 'bailian', ... },
  { id: 'llm_002', name: 'GPT-4', protocol: 'openai', ... },
  { id: 'llm_003', name: '豆包-Pro', protocol: 'volcano', ... }
]
```

### 2. 新增数据库表

```sql
-- v2.0 新增
CREATE TABLE llm_models (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  protocol TEXT NOT NULL,
  api_key TEXT NOT NULL,
  base_url TEXT NOT NULL,
  model_id TEXT NOT NULL,
  is_default INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3. 新增 API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/llm-models` | GET | 获取所有模型 |
| `/api/llm-models` | POST | 添加新模型 |
| `/api/llm-models/{id}` | PUT | 更新模型 |
| `/api/llm-models/{id}` | DELETE | 删除模型 |
| `/api/llm-models/test` | POST | 测试连接 |
| `/api/llm-models/default` | GET | 获取默认模型 |

---

## 🔄 升级步骤

### 自动升级（推荐）

如果你是从 v1.0 升级，数据库会自动迁移：

1. **备份数据**
   ```bash
   # 备份旧数据库
   copy storymap.db storymap.db.backup
   ```

2. **更新代码**
   ```bash
   git pull origin main
   ```

3. **安装依赖**
   ```bash
   # 后端依赖
   pip install -r requirements.txt
   
   # 前端依赖
   cd frontend
   npm install
   ```

4. **启动服务**
   ```bash
   # 使用启动脚本
   start.cmd
   
   # 或手动启动
   python backend/main.py
   cd frontend && npm run dev
   ```

5. **配置模型**
   - 打开应用：http://localhost:5173
   - 点击"🔮 法阵管理"
   - 添加你的 LLM 模型配置

### 手动升级

如果自动升级失败，可以手动执行：

1. **更新数据库**
   ```sql
   -- 连接到 storymap.db，执行以下 SQL
   CREATE TABLE IF NOT EXISTS llm_models (
     id TEXT PRIMARY KEY,
     name TEXT NOT NULL,
     protocol TEXT NOT NULL,
     api_key TEXT NOT NULL,
     base_url TEXT NOT NULL,
     model_id TEXT NOT NULL,
     is_default INTEGER DEFAULT 0,
     created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );
   ```

2. **迁移旧配置**
   
   如果你在 v1.0 中使用了 LocalStorage 存储配置：
   
   ```javascript
   // 打开浏览器控制台，执行：
   const oldConfig = JSON.parse(localStorage.getItem('llm_config'));
   console.log(oldConfig);
   // 将输出的配置手动添加到新的"法阵管理"界面
   ```

---

## 🆕 新功能使用指南

### 1. 添加第一个模型

1. 点击左侧"🔮 法阵管理"按钮
2. 填写模型信息：
   - 模型名称：`通义千问-Plus`
   - 协议类型：选择 `bailian`
   - Model ID：`qwen-plus`
   - Base URL：自动填充
   - API Key：粘贴你的密钥
3. 勾选"设为默认模型"
4. 点击"🧪 测试连接"
5. 测试成功后点击"➕ 添加"

### 2. 添加多个模型

重复上述步骤，添加不同的模型：

**示例配置：**

```
模型1：通义千问-Plus（日常使用）
  - 协议：bailian
  - Model ID：qwen-plus
  - 默认：是

模型2：通义千问-Turbo（快速测试）
  - 协议：bailian
  - Model ID：qwen-turbo
  - 默认：否

模型3：GPT-4（高质量分析）
  - 协议：openai
  - Model ID：gpt-4
  - 默认：否
```

### 3. 切换模型

1. 在"法阵管理"界面
2. 找到要使用的模型
3. 点击"选择"按钮
4. 当前选中的模型会显示"✓ 已选择"

### 4. 测试模型

在添加或编辑模型时：
1. 填写完整配置信息
2. 点击"🧪 测试连接"
3. 等待测试结果：
   - ✅ 成功：显示"连接成功"和响应内容
   - ❌ 失败：显示错误信息

---

## 🔧 兼容性说明

### 数据兼容性

- ✅ **项目数据**：完全兼容，无需迁移
- ✅ **节点数据**：完全兼容，无需迁移
- ✅ **关系数据**：完全兼容，无需迁移
- ⚠️ **LLM 配置**：需要重新配置（从 LocalStorage 迁移到数据库）

### API 兼容性

- ✅ 所有 v1.0 的 API 接口保持不变
- ✅ 新增的 API 接口不影响旧功能
- ✅ 前端组件向后兼容

### 界面变化

- 🔄 "⚙️ 配置法阵"按钮改为"⚙️ 快速配置"（已废弃）
- ✨ 新增"🔮 法阵管理"按钮（推荐使用）
- ✨ 演化控制台新增"当前法阵"显示

---

## 🐛 已知问题

### 1. 旧配置不会自动迁移

**问题：** v1.0 的 LLM 配置存储在 LocalStorage，不会自动迁移到数据库。

**解决：** 手动在"法阵管理"中重新添加配置。

### 2. 首次启动需要配置模型

**问题：** 升级后首次使用，需要先配置 LLM 模型才能进行推演。

**解决：** 按照"新功能使用指南"添加至少一个模型。

### 3. 旧版"快速配置"已废弃

**问题：** 点击"⚙️ 快速配置"会提示已废弃。

**解决：** 使用新的"🔮 法阵管理"功能。

---

## 📊 性能对比

| 指标 | v1.0 | v2.0 | 提升 |
|------|------|------|------|
| 模型配置数量 | 1 | 无限 | ∞ |
| 配置切换速度 | - | <1s | - |
| 配置测试功能 | ❌ | ✅ | 新增 |
| 协议支持数量 | 1 | 3 | 3x |
| 配置持久化 | LocalStorage | SQLite | 更可靠 |

---

## 🎯 迁移检查清单

升级完成后，请检查以下项目：

- [ ] 数据库文件存在且可访问
- [ ] 后端服务正常启动（端口 8000）
- [ ] 前端服务正常启动（端口 5173）
- [ ] 可以访问应用界面
- [ ] 旧项目数据正常显示
- [ ] 可以打开"法阵管理"界面
- [ ] 成功添加至少一个 LLM 模型
- [ ] 模型测试连接成功
- [ ] 可以选择并切换模型
- [ ] 推演功能正常工作
- [ ] 关系图谱正常显示

---

## 🆘 遇到问题？

### 常见问题

**Q: 升级后无法启动？**
A: 检查 Python 和 Node.js 依赖是否正确安装。

**Q: 数据丢失了？**
A: 检查 `storymap.db` 文件是否存在，如有备份请恢复。

**Q: 模型测试失败？**
A: 检查 API Key、Base URL 和网络连接。

**Q: 图谱不显示？**
A: 刷新页面，检查浏览器控制台错误信息。

### 获取帮助

1. 查看文档：
   - `README.md` - 快速开始
   - `功能说明.md` - 详细功能
   - `LLM配置示例.md` - 配置指南

2. 查看日志：
   - 后端日志：终端输出
   - 前端日志：浏览器控制台（F12）

3. 回滚到 v1.0：
   ```bash
   git checkout v1.0
   copy storymap.db.backup storymap.db
   ```

---

## 🎊 升级完成

恭喜你成功升级到 v2.0！现在你可以：

1. ✅ 配置多个 LLM 模型
2. ✅ 快速切换不同模型
3. ✅ 测试模型连接
4. ✅ 使用三种主流协议
5. ✅ 自定义 Base URL

开始享受更强大的众生谱吧！🚀
