# v2.4 快速切换优化说明

**作者：你们喜爱的老王**

## 更新内容

### 1. 快速切换卷宗体验优化

#### 问题
- 切换卷宗时需要等待数据加载和图谱渲染完成才能看到反馈
- 用户不知道系统是否在工作，体验不好
- 大数据量时渲染慢，阻塞 UI

#### 解决方案

**立即响应 + 异步加载**
```javascript
// 1. 立即切换项目ID，显示加载状态
set({ 
  currentProjectId: pid, 
  nodes: [], 
  edges: [], 
  isLoadingProject: true 
});

// 2. 异步加载数据
const data = await fetch(...);

// 3. 加载完成后更新
set({ 
  nodes: data.nodes, 
  edges: data.edges,
  isLoadingProject: false
});
```

### 2. 智能布局算法选择

根据数据量自动选择最优布局：

- **节点数 ≤ 50**：使用 `force` 布局（力导向，更美观）
- **节点数 > 50**：使用 `circular` 布局（圆形，更快）

### 3. 多层加载提示

#### 数据加载阶段
- 显示旋转加载动画
- 提示"正在加载卷宗数据..."
- 当前卷宗名称旁显示"(加载中...)"

#### 图谱渲染阶段
- 显示半透明遮罩
- 提示"正在渲染图谱 (X 个节点)..."
- 使用 `requestAnimationFrame` 异步渲染，不阻塞 UI

### 4. 性能优化

1. **限制迭代次数**：force 布局 maxIteration = 200
2. **异步渲染**：使用 requestAnimationFrame 延迟渲染
3. **清空旧数据**：切换时立即清空，避免渲染冲突
4. **状态管理**：新增 `isLoadingProject` 状态追踪加载过程

## 用户体验提升

### 之前
1. 点击卷宗
2. 等待 2-5 秒（无反馈）
3. 突然显示新图谱

### 现在
1. 点击卷宗
2. **立即**显示加载动画（0.1 秒内）
3. 显示"正在加载卷宗数据..."
4. 数据加载完成后显示"正在渲染图谱..."
5. 渲染完成，显示新图谱

## 技术细节

### 状态流转

```
用户点击 → 立即切换ID → 显示加载状态 → 异步加载数据 → 异步渲染图谱 → 完成
   ↓           ↓              ↓                ↓               ↓            ↓
  0ms        <50ms          50ms            200-1000ms      500-2000ms    完成
```

### 加载状态管理

```javascript
// store.js
isLoadingProject: false  // 新增状态

// GraphView.jsx
const isLoadingProject = useStore(state => state.isLoadingProject);
const [isRendering, setIsRendering] = useState(false);
```

## 测试建议

1. 测试小数据量（< 50 节点）：应该使用 force 布局
2. 测试大数据量（> 50 节点）：应该使用 circular 布局
3. 快速切换多个卷宗：应该看到流畅的加载动画
4. 观察控制台日志：确认异步加载流程

## 后续优化方向

1. 可以考虑数据预加载（鼠标悬停时预加载）
2. 可以考虑图谱缓存（切换回之前的卷宗时直接显示）
3. 可以考虑虚拟化渲染（超大数据量时只渲染可见区域）

---

更新时间：2026-02-19
版本：v2.4
